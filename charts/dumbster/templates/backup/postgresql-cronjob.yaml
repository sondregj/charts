{{ if .Values.backup.source.postgres.enabled }}
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: {{.Values.job.name}}-dumbster-postgres-backup
spec:
  schedule: {{.Values.backup.schedule | quote}} 
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: dumbster
            image: sondregj/dumbster:latest
            imagePullPolicy: Always
            env:
            - name: DUMPSTER_METHOD
              value: dump
            - name: DUMPSTER_DBMS
              value: pgsql
            - name: DUMPSTER_BACKUPS_MAX_AGE
              value: {{.Values.backup.retentionDays}}
            - name: DUMPSTER_CONNECTION_STRING
              valueFrom:
                secretKeyRef: 
                  name: {{.Values.backup.source.postgres.secretName}}
                  key: connectionString
            - name: DUMPSTER_DATABASES
              value: {{.Values.backup.source.postgres.databases | join " "}}
            
            - name: DUMPSTER_MOUNT_PATH
              value: {{.Values.backup.destination.azureFile.mountPath}}

            volumeMounts: 
              - name: backup-storage
                mountPath: {{.Values.backup.destination.azureFile.mountPath}}
          volumes: 
            - name: backup-storage
              azureFile:
                secretName: {{ .Values.backup.destination.azureFile.secretName }}
                shareName: {{ .Values.backup.destination.azureFile.shareName }}
                readOnly: {{ .Values.backup.destination.azureFile.readOnly }}
          restartPolicy: Never
{{ end }}
